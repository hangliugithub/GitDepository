<div id="patient">
	<p>
		<button id="create" onclick="create()">创建</button>
		<button id="update" onclick="update()">更新</button>
		<button id="del" onclick="deletes()">删除</button>&emsp;&emsp;&emsp;
		<input style="text" id="resourceId" placeholder="请输入资源ID">
		<button id="read" onclick="reads()">读取</button>
		<button id="history" onclick="history()">所有历史版本</button>
		&emsp;&emsp;&emsp;
		<input style="text" id="resourcename" placeholder="请输入病人姓名">
		<button id="search" onclick="searchs()">搜索</button>
	</p>
	
	<!--  start -->
	<div id="grid_div" class="grid">
		<span id="text">记录条数：</span>
		<select id="historyid"></select>
    	<table  class="table">
    		<caption align="top" style="font-size:20px">患者(Patient)</caption>
    		<tr>
				<td>
					资源id:<br><input id="patids" name="patids" type="text" readonly="readonly">
				</td>
				<td align="left"> 
					姓名:<br><input id="name1" name="patname" type="text" value="刘康">
				</td>
				<td align="left">
					性别:<br><select id="sex1" name="sex">
    					<option id="male" value="male">男</option>
    					<option id="female" value="female">女</option>
						</select>
				</td>
			</tr>	
			<tr>
				<td>
					身份证号:<br><input id="idcard1" type="text" value="110101200301120019">
				</td>
				<td>
					社保卡号:<br><input id="sscard1" type="text" value="4563123156123">
				</td>
				<td>
					手机:<br><input id="phone1" type="text" value="13800138000">
				</td>
			</tr>
			<tr>
				<td>
					出生年月:<br><input id="birthdate1" type="text" value="2003-01-12T10:04:01Z">
				</td>
				<td>
					联系人:<br><select id="relation1" name="relation">
    						<option value="male">父亲</option>
    						<option value="female">母亲</option>
							</select>
				</td>
				<td>
					联系人姓名:<br><input id="contact_name1" type="text" value="刘备">
				</td>				
			</tr>
			<tr>
				<td>
					联系人电话:<br><input id="contact_phone1" type="text" value="18679545215" placeholder="请输入电话号码">
				</td>
				<td>
					State:<br><input id="state1" type="text" value="浙江省">
				</td>
				<td>
					District:<br><input id="district1" type="text" value="西湖区">
				</td>
			</tr>
			<tr>
				<td>
					City:<br><input id="city1" type="text" value="杭州市">
				</td>
				<td>
					Line:<br><input id="line1" type="text" value="西湖风景区">
				</td>
				<td>
					PostalCode:<br><input id="postalcode1" type="text" value="326265">
				</td>
			</tr>
		</table>
	</div>
	
	<!--  end -->
	
	<!-- create patient start-->
	<!-- <div id="inps_div" class="inps" hidden="hidden">
		<p>姓名：&emsp;&emsp;<input name="name" type="text" value="Cooke"></p>
		<p>性别：&emsp;&emsp;<input type="radio" name="gender" checked="checked" value="male"/>男&emsp;<input type="radio" name="gender" value="female"/>女&emsp;</p>
		<p>身份证号：<input name="idcard" type="text" value="78941321321"></p>
		<p>社保卡号：<input name="sscard" type="text" value="4563123156123"></p>
		<p>出生年月：<input name="birthdate" type="text" value="2015-12-06"></p>
		<p>联系电话：<input name="phone" type="text" value="123456154984"></p>
		<p>联系人：
			<select id="contact_rel">
				<option value="male">父亲</option>
				<option value="female">母亲</option>
			</select>
			<input name="contact_name" type="text" value="姓名">
			<input name="contact_phone" type="text" value="45613546812">
		</p>
		<p>家庭住址：</p>
		<p>State:&emsp;&emsp;<input name="state" type="text" value="djfklas;sdf"></p>
		<p>District:&emsp;&emsp;<input name="district" type="text" value="dfsafas"></p>
		<p>City:&emsp;&emsp;<input name="city" type="text" value="jdfksal;f"></p>
		<p>Line:&emsp;&emsp;<input name="line" type="text" value="dfjsakl;fd"></p>
		<p>PostalCode:&emsp;<input name="postalcode" type="text" value="456151324"></p>
		<p><button id="sure">确定</button>&emsp;<button id="cancel">取消</button></p>
	</div> -->
	
	<script type="text/javascript">
	//数据类型
	function changedatatype(){
		var datatype=$("#dataFormat").val();
		$.ajax({
			url:"/fhirclient/patient/changeType.do",
			data:{format:datatype},
			type:"post",
			cache:false,
			success:function(data){
				if(data.state==1)
					alert(data.message);
			}
		});
	}
	//服务器
	function changeserverbase(){
		contextData.fhirclient=$("#serv").val();
		var base=$("#serv").val().trim();
		$.ajax({
			url:"/fhirclient/patient/changeServerBase.do",
			data:{serverBase:base},
			type:"post",
			cache:false,
			success:function(data){
				if(data.state==1)
					alert(data.message);
			}
		});
	}
	
	var patient={
		    "resourceType": "Patient",

		    "identifier": [
		        {
		            "system": "2.16.840.1.113883.2.23.1.9.1",
		            "value": ""
		        },
		        {
		            "system": "2.16.840.1.113883.2.23.1.9.2",
		            "value": ""
		        }
		    ],
		    "name": [
		        {
		            "text": ""
		        }
		    ],
		    "telecom": [
		        {
		            "system": "phone",
		            "value": "",
		            "use": "mobile"
		        }
		    ],
		    "gender": "",
		    "birthDate": "",
		    "address": [
		        {
		            "use": "home",
		            "line": [
		                ""
		            ],
		            "city": "",
		            "district": "",
		            "state": "",
		            "postalCode": ""
		        }
		    ],
		    "contact": [
		        {
		            "relationship": [
		                {
		                    "coding": [
		                        {
		                            "system": "http://hl7.org/fhir/patient-contact-relationship",
		                            "code": "parent"
		                        }
		                    ]
		                }
		            ],
		            "name": {
		                "text": ""
		            },
		            "telecom": [
		                {
		                    "system": "phone",
		                    "value": ""
		                }
		            ],
		            "gender": ""
		        }
		    ]
		}
	/* $("#create").click(function(){
		$("#inps_div").fadeIn();
		$("#grid_div").fadeOut();
	});
	$("#cancel").click(function(){$("#inps_div").fadeOut()}); */
	/* $("#cancel2").click(function(){$("#grid_div").fadeOut()}); */
	$("#historyid").change(selectchange);
	//给input赋值
	function setInput(data){	
		$("#grid_div").fadeIn();
		$("#inps_div").fadeOut();
	    $("#patids").val(data.id);
	    $("#name1").val(data.name[0].text);
	    $("#idcard1").val(data.identifier[0].value);
	    $("#sscard1").val(data.identifier[1].value);
	    $("#birthdate1").val(data.birthDate);
	    if(data._birthDate){
	    	$("#birthdate1").val(data._birthDate.extension[0].valueDateTime);
	    }
	    $("#phone1").val(data.telecom[0].value);
	    $("#relation1").val(data.contact[0].gender)
	    $("#contact_name1").val(data.contact[0].name.text);
	    $("#contact_phone1").val(data.contact[0].telecom[0].value);
	    $("#state1").val(data.address[0].state);
	    $("#district1").val(data.address[0].district);
	    $("#city1").val(data.address[0].city);
	    $("#line1").val(data.address[0].line);
	    $("#postalcode1").val(data.address[0].postalCode);
	    $("#sex1").val(data.gender);
	    $("#relation1").val(data.contact[0].relationship[0].coding[0].code);		
	}
	
	//获取input的值
	function getInputs(data){
	    data.name[0].text=$("#name1").val();
        data.gender = $("#sex1").val();
        data.identifier[0].value=$("#idcard1").val();
        data.identifier[1].value=$("#sscard1").val();
        data.birthDate=$("#birthdate1").val();
        data.telecom[0].value=$("#phone1").val();
        data.contact[0].name.text=$("#contact_name1").val();
        data.contact[0].telecom[0].value=$("#contact_phone1").val();
        data.contact[0].gender=$("#relation1").val();
        data.address[0].state=$("#state1").val();
        data.address[0].district=$("#district1").val();
        data.address[0].city=$("#city1").val();
        data.address[0].line[0]=$("#line1").val();
        data.address[0].postalCode=$("#postalcode1").val();
	}
	
	//通过名字搜索
	function searchs(){
		$("button").attr("disabled","disabled").css("background","gray");
		//$("button").removeAttr("disabled").css("background","#3F48CC");
		$("#text").html("记录条数");
		var name=$("#resourcename").val();
		var url = "/fhirclient/patient/search.do?name="+name;
		$.getJSON(url,function(result){
			$("button").removeAttr("disabled").css("background","#3F48CC");
			$("#inps_div").fadeOut();
			$("#grid_div").fadeIn();
    		if(result.state==0){
    			console.log(result.data);
    			if(result.data.length<=0){
    				alert("未找到！");
    				return;
    			}
				var his = $("#historyid");
				his.html("");
    			model.objs = [];
    			for(var i=0;i<result.data.length;i++){
    				var p = JSON.parse(result.data[i]);
    				console.log(p);
    				model.objs[i] = p;
					var value=i;
					var text=model.objs[i].id;
					his.append("<option value='"+value+"'>"+text+"</option>");
    			}
    			model.obj = model.objs[0];
    			setInput(model.obj);
    		}else{
    			alert(result.message);
    		}
		});
	}
	
	function selectchange(){
		var index=$("#historyid").val();
		console.log(index);
		setInput(model.objs[index]);
	}
	
	//删除
	function deletes(){
		$("button").attr("disabled","disabled").css("background","gray");
		//$("button").removeAttr("disabled").css("background","#3F48CC");
		if(confirm("确定删除？")){
			var id=$("#resourceId").val();
			var url = "/fhirclient/patient/del.do?id="+id;
			$.getJSON(url,function(result){
				$("button").removeAttr("disabled").css("background","#3F48CC");
	    		if(result.state==0){
	    			alert("删除成功");
	    			model.obj={};
	    			//setInput(model.obj);
	    		}else{
	    			alert(result.message);
	    		}
	    	});
    	}
	}
	
	
	//获得历史版本
	function history(){
		$("button").attr("disabled","disabled").css("background","gray");
		//$("button").removeAttr("disabled").css("background","#3F48CC");
		$("#text").html("历史记录");
		var id=$("#resourceId").val();
		//到后台
		$.ajax({
			url:"/fhirclient/patient/his.do?id="+id,
			type:"get",
			cache:"false",
			success:function(result){
				$("button").removeAttr("disabled").css("background","#3F48CC");
				$("#inps_div").fadeOut();
				$("#grid_div").fadeIn();
	    		if(result.state==0){
	    			console.log(result.data);
	    			model.objs = [];
	    			var his = $("#historyid");
					his.html("");
	    			for(var i=0;i<result.data.length;i++){
	    				var p = JSON.parse(result.data[i]);
	    				console.log(p);
	    				model.objs[i] = p;
	    				
	    				var value=i;
						var text=model.objs[i].meta.versionId;
						his.append("<option value='"+value+"'>"+text+"</option>");
	    			}
	    			model.obj = model.objs[0];
	    			setInput(model.obj);
	    		}else{
	    			alert(result.message);
	    		}
			}
		});
	}
	
	//更新病人信息
	function update(){
		$("button").attr("disabled","disabled").css("background","gray");
		//$("button").removeAttr("disabled").css("background","#3F48CC");
		if(confirm("确认更新?")){
			getInputs(model.obj);
			//到后台
			var str = JSON.stringify(model.obj);
			console.log(str);
			$.ajax({
				url:"/fhirclient/patient/update.do",
				type:"post",
				data:{data:str},
				cache:"false",
				success:function(result){
					$("button").removeAttr("disabled").css("background","#3F48CC");
	        		if(result.state==0){
	        			alert("更新成功");
	        		}else{
	        			alert(result.message);
	        		}
				}
			});
		}
	}
	
	
	//根据id获取病人信息
	function reads(){
		$("button").attr("disabled","disabled").css("background","gray");
		//$("button").removeAttr("disabled").css("background","#3F48CC");
		var id=$("#resourceId").val();
		//到后台
		$.ajax({
			url:"/fhirclient/patient/read.do?id="+id,
			type:"get",
			cache:"fasle",
			success:function(result){
				$("button").removeAttr("disabled").css("background","#3F48CC");
        		if(result.state==0){
        			model.obj = JSON.parse(result.data);
        			setInput(model.obj);
					$("#inps_div").fadeOut();
					$("#grid_div").fadeIn();
        		}else{
        			alert(result.message);
        		}
			}
		});
	
	}
	
	function create(){
		//给上面的Patient对象的属性赋值
		getInputs(patient);
		//通过ajax调用服务端RestFul api发送以上patient对象的json字符串
        var str = JSON.stringify(patient);
		console.log(str);
		$("button").attr("disabled","disabled").css("background","gray");
		//$("button").removeAttr("disabled").css("background","#3F48CC");
        //到后台	
        $.ajax({
        	url:"/fhirclient/patient/create.do",
        	cache:"false",
        	data:{data:str},
        	type:"post",
        	success:function(result){
        		$("button").removeAttr("disabled").css("background","#3F48CC");
        		if(result.state==0){
        			alert("创建成功！ID:"+result.data);
        		}else{
        			alert(result.message);
        		}
        	}
        });
	}
	</script>
	<!-- create patient end -->
</div>